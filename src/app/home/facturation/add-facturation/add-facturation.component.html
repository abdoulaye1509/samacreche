<div class="modal-header">
  <h1 class="modal-title fs-6">
    <i class="bi bi-receipt-cutoff me-2"></i> Nouvelle facture
  </h1>
  <button type="button" class="btn-close" aria-label="Fermer" (click)="activeModal.close()"></button>
</div>

<div class="modal-body">
  <form [formGroup]="reactiveForm_add_facturation"
        (ngSubmit)="onSubmit_add_facturation()"
        #form_add_facturation="ngForm"
        class="row g-3">

    <!-- Enfant -->
    <div class="col-12">
      <label class="form-label">
        <i class="bi bi-person-badge me-1"></i> Enfant à facturer
      </label>

      <ng-select
        [items]="form_details?.les_enfants || []"
        bindValue="id_enfant"
        placeholder="Choisir l’enfant"
        formControlName="id_enfant"
        [ngClass]="{ 'is-invalid': submitted && f['id_enfant'].errors }">

        <!-- libellé affiché dans le champ -->
        <ng-template ng-label-tmp let-item="item">
          {{ item?.prenom_enfant }} {{ item?.nom_enfant }}
        </ng-template>

        <!-- rendu des options -->
        <ng-template ng-option-tmp let-item="item">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-person-circle text-primary"></i>
            <span class="fw-semibold">{{ item?.prenom_enfant }} {{ item?.nom_enfant }}</span>
          </div>
        </ng-template>
      </ng-select>

      <div class="invalid-feedback" *ngIf="submitted && f['id_enfant'].errors">
        L’enfant est obligatoire.
      </div>
    </div>

    <!-- Mois & Date -->
    <div class="col-sm-6">
      <label class="form-label"><i class="bi bi-calendar2-month me-1"></i> Mois de facturation</label>
      <input type="month" class="form-control"
             formControlName="mois_facture"
             [ngClass]="{ 'is-invalid': submitted && f.mois_facture.errors }">
      <div class="invalid-feedback" *ngIf="submitted && f.mois_facture.errors">Requis (format YYYY-MM).</div>
    </div>

    <div class="col-sm-6">
      <label class="form-label"><i class="bi bi-calendar-event me-1"></i> Date de facturation</label>
      <input type="date" class="form-control"
             formControlName="date_facturation"
             [ngClass]="{ 'is-invalid': submitted && f.date_facturation.errors }">
      <div class="invalid-feedback" *ngIf="submitted && f.date_facturation.errors">Requis.</div>
    </div>

    <!-- Libellé & Désignation optionnelle -->
    <div class="col-12">
      <label class="form-label"><i class="bi bi-card-text me-1"></i> Libellé de la facture</label>
      <input type="text" class="form-control"
             placeholder="Ex. Mensualité Novembre 2025"
             formControlName="libelle_facturation"
             [ngClass]="{ 'is-invalid': submitted && f.libelle_facturation.errors }">
      <div class="invalid-feedback" *ngIf="submitted && f.libelle_facturation.errors">Requis.</div>
    </div>

   

   <!-- Bloc montants auto -->
<div class="col-12">
  <div class="row g-2 align-items-end">
    <!-- Mensualité -->
    <div class="col-sm-4">
      <label class="form-label">
        <i class="bi bi-mortarboard me-1"></i> Mensualité
      </label>

      <!-- Montant brut -->
      <div class="input-group mb-1">
        <span class="input-group-text">CFA</span>
        <input class="form-control"
               formControlName="montant_mensualite"
               type="number"
               min="0"
               step="100"
               (input)="recalcTotal()">
      </div>
      <div class="form-text">Récupérée automatiquement depuis la fiche enfant.</div>

      <!-- Remise % -->
      <div class="mt-2">
        <label class="form-label mb-1">Remise mensualité (%)</label>
        <div class="input-group input-group-sm">
          <input class="form-control"
                 type="number"
                 min="0"
                 max="100"
                 step="1"
                 formControlName="remise_mensualite_pct"
                 (input)="recalcTotal()">
          <span class="input-group-text">%</span>
        </div>
      </div>
    </div>

    <!-- Cantine -->
    <div class="col-sm-4">
      <label class="form-label">
        <i class="bi bi-egg-fried me-1"></i> Cantine
      </label>

      <!-- Montant brut -->
      <div class="input-group mb-1">
        <span class="input-group-text">CFA</span>
        <input class="form-control"
               formControlName="montant_cantine"
               type="number"
               min="0"
               step="100"
               (input)="recalcTotal()">
      </div>
      <div class="form-text">
        <span class="badge bg-light text-dark">Statut: {{ f.cantine.value || '—' }}</span>
      </div>

      <!-- Remise % -->
      <div class="mt-2">
        <label class="form-label mb-1">Remise cantine (%)</label>
        <div class="input-group input-group-sm">
          <input class="form-control"
                 type="number"
                 min="0"
                 max="100"
                 step="1"
                 formControlName="remise_cantine_pct"
                 (input)="recalcTotal()">
          <span class="input-group-text">%</span>
        </div>
      </div>
    </div>

    <!-- Total net à payer -->
    <div class="col-sm-4">
      <label class="form-label fw-bold">
        <i class="bi bi-calculator me-1"></i> Total NET
      </label>
      <div class="input-group">
        <span class="input-group-text">CFA</span>
        <input class="form-control fw-bold"
               formControlName="montant_total"
               type="number"
               readonly>
      </div>
      <div class="form-text">
        Somme des montants après remise.
      </div>
    </div>
  </div>
</div>

    <!-- Statut (si disponible) -->
    <div class="col-md-6" *ngIf="(form_details?.les_statuts?.length || 0) > 0">
      <label class="form-label"><i class="bi bi-flag me-1"></i> Statut</label>
      <ng-select
        [items]="form_details?.les_statuts"
        bindLabel="libelle_statut_facture"
        bindValue="id_statut_facture"
        placeholder="Choisir un statut"
        formControlName="id_statut_facture">
      </ng-select>
    </div>

  

  </form>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-primary"
          [disabled]="loading_add_facturation || loading_get_details_add_facturation_form"
          (click)="form_add_facturation.ngSubmit.emit()">
    {{ loading_add_facturation ? "En cours..." : "Valider" }}
  </button>
  <button type="button" class="btn btn-outline-secondary" (click)="activeModal.close()">Fermer</button>
</div>
