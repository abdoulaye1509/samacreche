<div class="modal-header" data-bs-theme="light">
  <h1 class="modal-title fs-5">Ajouter un utilisateur</h1>
  <button type="button" class="btn-close" aria-label="Close" (click)="activeModal.close()"></button>
</div>

<div class="modal-body">
  <form
    [formGroup]="reactiveForm_add_utilisateur"
    (ngSubmit)="onSubmit_add_utilisateur()"
    class="d-flex flex-column gap-4"
  >
    <!-- SECTION 1 : Infos générales -->
    <div class="border rounded-3 p-3 p-md-4 bg-body">
      <div class="mb-3">
        <h6 class="mb-1">Informations générales</h6>
        <small class="text-muted">Identité et informations de base</small>
      </div>

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Genre <span class="text-danger">*</span></label>
          <ng-select
            [items]="form_details.genres"
            bindLabel="nom_genre"
            bindValue="id_genre"
            placeholder="Sélectionner"
            formControlName="id_genre"
            [ngClass]="{ 'is-invalid': submitted && f.id_genre.errors }"
          ></ng-select>
          @if (submitted && f.id_genre.errors) {
            <div class="invalid-feedback d-block">Champ obligatoire</div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Groupe sanguin</label>
          <ng-select
            [items]="form_details.groupes_sanguins"
            bindLabel="libelle_groupe_sanguin"
            bindValue="id_groupe_sanguin"
            placeholder="Optionnel"
            formControlName="id_groupe_sanguin"
          ></ng-select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Prénom <span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="text"
            formControlName="prenom_utilisateur"
            placeholder="Ex: Awa"
            [ngClass]="{ 'is-invalid': submitted && f.prenom_utilisateur.errors }"
          />
          @if (submitted && f.prenom_utilisateur.errors) {
            <div class="invalid-feedback">Champ obligatoire</div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Nom <span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="text"
            formControlName="nom_utilisateur"
            placeholder="Ex: Diop"
            [ngClass]="{ 'is-invalid': submitted && f.nom_utilisateur.errors }"
          />
          @if (submitted && f.nom_utilisateur.errors) {
            <div class="invalid-feedback">Champ obligatoire</div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Date de naissance</label>
          <input class="form-control" type="date" formControlName="date_naissance" />
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Profil / Fonction</label>
          <input
            class="form-control"
            type="text"
            formControlName="profil_utilisateur"
            placeholder="Ex: Directrice, Éducatrice, Comptable..."
          />
        </div>
      </div>
    </div>

    <!-- SECTION 2 : Contact -->
    <div class="border rounded-3 p-3 p-md-4 bg-body">
      <h6 class="mb-3">Contact</h6>
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Téléphone <span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="text"
            formControlName="telephone_utilisateur"
            placeholder="+221 77 000 00 00"
            [ngClass]="{ 'is-invalid': submitted && f.telephone_utilisateur.errors }"
          />
          @if (submitted && f.telephone_utilisateur.errors) {
            <div class="invalid-feedback">Champ obligatoire</div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Email <span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="email"
            formControlName="email_utilisateur"
            placeholder="user@creche.sn"
            [ngClass]="{ 'is-invalid': submitted && f.email_utilisateur.errors }"
          />
          @if (submitted && f.email_utilisateur.errors) {
            <div class="invalid-feedback">
              @if (f.email_utilisateur.errors.required) { Champ obligatoire }
              @if (f.email_utilisateur.errors.email) { Email invalide }
            </div>
          }
        </div>

        <div class="col-12">
          <label class="form-label">Adresse</label>
          <input
            class="form-control"
            type="text"
            formControlName="adresse_utilisateur"
            placeholder="Rue, quartier, ville..."
          />
        </div>
      </div>
    </div>

    <!-- SECTION 3 : Affectation -->
    <div class="border rounded-3 p-3 p-md-4 bg-body">
      <h6 class="mb-3">Affectation</h6>

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Structure <span class="text-danger">*</span></label>
          <ng-select
            [items]="form_details.structures"
            bindLabel="nom_structure"
            bindValue="id_structure"
            placeholder="Sélectionner une structure"
            formControlName="id_structure"
            [ngClass]="{ 'is-invalid': submitted && f.id_structure.errors }"
          ></ng-select>
          @if (submitted && f.id_structure.errors) {
            <div class="invalid-feedback d-block">Champ obligatoire</div>
          }
          <small class="text-muted d-block mt-1">
            @if (api.user_connected?.id_privilege != 1) { Structure imposée à votre crèche }
            @if (api.user_connected?.id_privilege == 1) { Le superadmin peut choisir n’importe quelle structure }
          </small>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Privilège <span class="text-danger">*</span></label>
          <ng-select
            [items]="form_details.privileges"
            bindLabel="nom_privilege"
            bindValue="id_privilege"
            placeholder="Sélectionner un privilège"
            formControlName="id_privilege"
            [ngClass]="{ 'is-invalid': submitted && f.id_privilege.errors }"
          ></ng-select>
          @if (submitted && f.id_privilege.errors) {
            <div class="invalid-feedback d-block">Champ obligatoire</div>
          }
          <small class="text-muted d-block mt-1">
            @if (api.user_connected?.id_privilege != 1) { La liste est filtrée : pas de DEV, pas de superadmin }
            @if (api.user_connected?.id_privilege == 1) { Le superadmin peut attribuer tous les privilèges }
          </small>
        </div>
      </div>
    </div>

    <!-- SECTION 4 : Sécurité -->
    <div class="border rounded-3 p-3 p-md-4 bg-body">
      <h6 class="mb-3">Sécurité</h6>
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Mot de passe <span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="password"
            formControlName="mot_de_passe"
            placeholder="••••••••"
            [ngClass]="{ 'is-invalid': submitted && f.mot_de_passe.errors }"
          />
          @if (submitted && f.mot_de_passe.errors) {
            <div class="invalid-feedback">Champ obligatoire</div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Statut <span class="text-danger">*</span></label>
          <ng-select
            [items]="form_details.statuts_utilisateur"
            bindLabel="libelle_statut_utilisateur"
            bindValue="id_statut_utilisateur"
            placeholder="Sélectionner"
            formControlName="id_statut_utilisateur"
            [ngClass]="{ 'is-invalid': submitted && f.id_statut_utilisateur.errors }"
          ></ng-select>
          @if (submitted && f.id_statut_utilisateur.errors) {
            <div class="invalid-feedback d-block">Champ obligatoire</div>
          }
        </div>
      </div>
    </div>

    <button type="submit" class="d-none"></button>
  </form>
</div>

<div class="modal-footer d-flex justify-content-between">
  <button type="button" class="btn btn-outline-secondary" (click)="activeModal.close()">
    Annuler
  </button>
  <button
    type="button"
    class="btn btn-primary"
    [disabled]="loading_add_utilisateur"
    (click)="onSubmit_add_utilisateur()"
  >
    <span *ngIf="loading_add_utilisateur" class="spinner-border spinner-border-sm me-2"></span>
    {{ loading_add_utilisateur ? 'Création en cours...' : 'Créer l\'utilisateur' }}
  </button>
</div>
