<div class="d-flex align-items-center justify-content-between mb-4">
  <div class="d-flex align-items-center">
    <!-- flèche retour (cachée si c'est une vraie modale) -->
    <button *ngIf="!activeModal" type="button" class="btn btn-light btn-sm me-2" (click)="goBack()" title="Retour">
      <i class="bi bi-arrow-left"></i>
    </button>

    <h5 class="mb-0 text-primary">
      <i class="bi bi-patch-check-fill me-2"></i>
      Dossier Enfant • E°{{ enfant?.id_enfant }}
      <span class="ms-2">|</span>
      <span class="fw-bold ms-2">{{ enfant?.prenom_enfant | uppercase }} {{ enfant?.nom_enfant | uppercase }}</span>
    </h5>
  </div>

  <button *ngIf="activeModal" type="button" class="btn-close" (click)="activeModal.close()"></button>
</div>

<!-- état : chargement -->
<div *ngIf="loading_get_enfant" class="text-center text-secondary py-5">
  <div class="spinner-border" role="status"></div>
  <div class="mt-2">Chargement…</div>
</div>

<ng-container *ngIf="!loading_get_enfant && enfant; else emptyTpl">

  <!-- Sommaire collant (visible quand les données sont prêtes) -->
  <nav class="card subnav sticky-top z-1 mb-3" style="top: 70px;" aria-label="Sommaire enfant">
    <div class="card-body p-2">
      <ul class="nav nav-pills gap-2 flex-wrap">
        <li class="nav-item">
          <a class="nav-link" href="#infos">
            <i class="bi bi-person-lines-fill me-1"></i> Infos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#activites">
            <i class="bi bi-journal-text me-1"></i> Cahiers de vie
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#galerie">
            <i class="bi bi-images me-1"></i> Galerie photos
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Ancre Infos (avant le bloc des onglets pour un scroll parfait) -->
  <span id="infos" class="anchor-offset"></span>

  <!-- Onglets Infos / Parents (inchangés sur le fond) -->
  <ul class="nav nav-tabs tabs-custom mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link" [class.active]="activeTab === 'info'" (click)="activeTab = 'info'" type="button" role="tab">
        <i class="bi bi-person-fill me-1"></i> Informations de l’enfant
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" [class.active]="activeTab === 'parents'" (click)="activeTab = 'parents'" type="button" role="tab">
        <i class="bi bi-people-fill me-1"></i> Parents / Tuteurs
        <span class="badge rounded-pill ms-2" [ngClass]="parents?.length ? 'text-bg-primary' : 'text-bg-secondary'">
          {{ parents?.length || 0 }}
        </span>
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Onglet Infos -->
    <div class="tab-pane fade show" [class.active]="activeTab === 'info'" role="tabpanel">
      <div class="card p-3 border-0 anim-container fade-in-up">
        <div class="row g-2 align-items-start">
          <div class="col-md-4 col-lg-3 text-center">
            <div class="ratio ratio-1x1 border border-3 rounded-circle overflow-hidden bg-light d-inline-block p-1 photo-frame zoom-in">
              <img [src]="enfant?.photo_enfant ? api.resolveFileUrl(enfant.photo_enfant) : api.placeholderLogo"
                   (error)="$any($event.target).src = api.placeholderLogo"
                   class="w-100 h-100 object-fit-cover rounded-circle" alt="photo enfant">
            </div>

            <h6 class="mt-2 fw-bold fade-in" style="--delay: .15s;">
              {{ enfant?.prenom_enfant | titlecase }} {{ enfant?.nom_enfant | titlecase }}
            </h6>

            <span class="badge bg-success-subtle text-success mt-1 fade-in" style="--delay: .25s;" *ngIf="enfant?.id_structure">
              Structure: {{ enfant?.nom_structure }}
            </span>
          </div>

          <div class="col-md-8 col-lg-9">
            <div class="row g-2 border-start ps-3 ps-md-4 grid-animate">
              <!-- Identité -->
              <div class="col-12">
                <h6 class="section-title fade-in" style="--delay: .2s;">
                  <i class="bi bi-person-badge"></i> Identité
                </h6>
              </div>
              <div class="col-sm-6 info-item" style="--i:0">
                <div class="label"><i class="bi bi-card-text"></i> Prénom</div>
                <div class="value">{{ enfant?.prenom_enfant }}</div>
              </div>
              <div class="col-sm-6 info-item" style="--i:1">
                <div class="label"><i class="bi bi-person-lines-fill"></i> Nom</div>
                <div class="value">{{ enfant?.nom_enfant }}</div>
              </div>

              <!-- Naissance -->
              <div class="col-12 mt-2">
                <h6 class="section-title fade-in" style="--delay: .3s;">
                  <i class="bi bi-balloon-heart"></i> Naissance
                </h6>
              </div>
              <div class="col-sm-6 info-item" style="--i:2">
                <div class="label"><i class="bi bi-calendar-event"></i> Date de naissance</div>
                <div class="value">{{ enfant?.date_naissance | date:'dd/MM/yyyy' }}</div>
              </div>
              <div class="col-sm-6 info-item" *ngIf="enfant?.lieu_naissance" style="--i:3">
                <div class="label"><i class="bi bi-geo-alt"></i> Lieu de naissance</div>
                <div class="value">{{ enfant?.lieu_naissance }}</div>
              </div>

              <!-- Adresse -->
              <ng-container *ngIf="enfant?.adresse_enfant">
                <div class="col-12 mt-2">
                  <h6 class="section-title fade-in" style="--delay: .35s;">
                    <i class="bi bi-geo-fill"></i> Adresse
                  </h6>
                </div>
                <div class="col-12 info-item" style="--i:4">
                  <div class="label"><i class="bi bi-house-door"></i> Adresse complète</div>
                  <div class="value">{{ enfant?.adresse_enfant }}</div>
                </div>
              </ng-container>

              <!-- Informations -->
              <div class="col-12 mt-2">
                <h6 class="section-title fade-in" style="--delay: .4s;">
                  <i class="bi bi-info-circle"></i> Informations
                </h6>
              </div>
              <div class="col-sm-4 info-item" *ngIf="enfant?.id_genre" style="--i:5">
                <div class="label"><i class="bi bi-gender-ambiguous"></i> Genre</div>
                <span class="badge text-bg-info text-capitalize">{{ enfant?.nom_genre || 'Non spécifié' }}</span>
              </div>
              <div class="col-sm-4 info-item" *ngIf="enfant?.id_pays" style="--i:6">
                <div class="label"><i class="bi bi-flag"></i> Pays</div>
                <span class="badge text-bg-secondary">{{ enfant?.nom_pays || enfant?.id_pays }}</span>
              </div>
              <div class="col-sm-4 info-item" *ngIf="enfant?.lien_juridique" style="--i:7">
                <div class="label"><i class="bi bi-passport"></i> Nationalité</div>
                <span class="badge text-bg-warning">{{ enfant?.lien_juridique }}</span>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Onglet Parents -->
    <div class="tab-pane fade show" [class.active]="activeTab === 'parents'" role="tabpanel">
      <ng-container *ngIf="parents?.length; else noParent">
        <div class="row g-4">
          <div class="col-12 col-md-6 col-xl-4" *ngFor="let p of parents">
            <div class="card h-100 shadow-hover border-primary-subtle fade-in-up" style="--delay:.08s;">
              <div class="card-body">
                <div class="d-flex gap-3 align-items-center mb-3 border-bottom pb-3">
                  <div class="avatar-circle avatar-lg bg-light-blue text-primary">
                    <span>{{ (p?.prenom_parent?.[0] || 'P') + (p?.nom_parent?.[0] || '') | uppercase }}</span>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-bold fs-5 text-truncate">{{ p?.prenom_parent }} {{ p?.nom_parent }}</div>
                    <span class="badge bg-primary-subtle text-primary fw-bold">
                      <i class="bi bi-link-45deg me-1"></i> {{ p?.libelle_lien_parente || 'Parent/Tuteur' }}
                    </span>
                  </div>
                </div>

                <div class="text-muted small d-grid gap-2">
                  <div *ngIf="p?.adresse_parent" class="d-flex align-items-start">
                    <i class="bi bi-geo-alt-fill me-2 mt-1 text-primary"></i>
                    <span>{{ p.adresse_parent }}</span>
                  </div>
                  <div *ngIf="p?.email_parent" class="d-flex align-items-start">
                    <i class="bi bi-envelope-fill me-2 mt-1 text-primary"></i>
                    <span class="text-truncate">{{ p.email_parent }}</span>
                  </div>
                  <div *ngIf="p?.telephone_parent" class="d-flex align-items-start">
                    <i class="bi bi-phone-fill me-2 mt-1 text-primary"></i>
                    <span class="text-truncate">{{ p.telephone_parent }}</span>
                  </div>
                  <div *ngIf="p?.cni" class="d-flex align-items-start">
                    <i class="bi bi-fingerprint me-2 mt-1 text-primary"></i>
                    <span>CNI: {{ p.cni }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #noParent>
        <div class="text-center text-secondary py-5 border rounded bg-light-subtle">
          <i class="bi bi-info-circle fs-3 d-block mb-2"></i>
          Aucun parent lié à cet enfant.
        </div>
      </ng-template>
    </div>
  </div>

  <!-- === Section Cahiers de vie === -->
  <section id="activites" class="section-block fade-in-up">
    <div class="section-header">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-journal-text text-primary"></i>
        <h5 class="m-0">Cahiers de vie</h5>
      </div>
      <p class="text-secondary m-0 small">Les activités quotidiennes renseignées pour l’enfant.</p>
    </div>

    <app-list-activite *ngIf="id_enfant!=0" [id_enfant]="id_enfant"></app-list-activite>
  </section>

  <!-- === Section Galerie photos === -->
  <section id="galerie" class="section-block fade-in-up" style="--delay:.06s;">
    <div class="section-header">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-images text-primary"></i>
        <h5 class="m-0">Galerie photos</h5>
      </div>
      <p class="text-secondary m-0 small">Les photos prises à la crèche et partagées aux parents.</p>
    </div>

    <app-list-galerie-enfant *ngIf="id_enfant!=0" [id_enfant]="id_enfant"></app-list-galerie-enfant>
  </section>

</ng-container>

<ng-template #emptyTpl>
  <div class="text-center text-secondary py-5">
    <i class="bi bi-emoji-frown fs-1 d-block mb-2"></i>
    Aucune donnée enfant.
  </div>
</ng-template>
